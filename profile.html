<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Security Headers (HTTP-only, meta is fallback) -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  
  <title>My Profile - Baldi Mods Hub (GameBanana Style)</title>
  <meta name="description" content="Your Baldi's Basics modding profile - Manage your mods, stats, and settings">
  
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90' fill='%2300ff88'>üéì</text></svg>">
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Stylesheets -->
  <link rel="stylesheet" href="style.css">
  
  <!-- Supabase Library -->
  <script src="js/supabase.min.js"></script>
  
  <!-- Config -->
  <script src="config.js"></script>
  
  <style>
    /* GameBanana Profile Styles */
    :root {
      --gb-primary: #00ff88;
      --gb-primary-dark: #00cc66;
      --gb-secondary: #ffaa00;
      --gb-danger: #ff4444;
      --gb-info: #2196f3;
      --gb-bg: #0a0a0a;
      --gb-bg-light: #1a1a1a;
      --gb-bg-lighter: #222;
      --gb-border: #333;
      --gb-text: #fff;
      --gb-text-muted: #ccc;
      --gb-text-dark: #666;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--gb-bg);
      color: var(--gb-text);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
    }

    /* GameBanana Header */
    .gb-header {
      background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
      border-bottom: 3px solid var(--gb-primary);
      padding: 20px 0;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }

    .gb-header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .gb-logo {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .gb-logo-icon {
      font-size: 48px;
      filter: drop-shadow(0 0 10px rgba(0,255,136,0.3));
    }

    .gb-logo-text h1 {
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -0.5px;
      background: linear-gradient(135deg, #fff 0%, #00ff88 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 5px;
    }

    .gb-logo-tagline {
      color: var(--gb-text-muted);
      font-size: 14px;
      font-weight: 500;
    }

    /* GameBanana Navigation */
    .gb-nav {
      background: var(--gb-bg-light);
      border-bottom: 1px solid var(--gb-border);
      padding: 0;
      position: sticky;
      top: 120px;
      z-index: 999;
    }

    .gb-nav-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .gb-nav-links {
      display: flex;
      gap: 5px;
      padding: 10px 0;
    }

    .gb-nav-item {
      color: var(--gb-text-muted);
      text-decoration: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .gb-nav-item:hover {
      color: var(--gb-text);
      background: rgba(255,255,255,0.05);
    }

    .gb-nav-item.active {
      color: var(--gb-text);
      background: linear-gradient(135deg, rgba(0,255,136,0.15) 0%, rgba(0,255,136,0.05) 100%);
      border-bottom: 2px solid var(--gb-primary);
    }

    /* GameBanana Profile Layout */
    .gb-profile {
      max-width: 1400px;
      margin: 40px auto;
      padding: 0 30px;
    }

    .gb-profile-grid {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 30px;
    }

    /* Profile Sidebar - GameBanana Style */
    .gb-profile-sidebar {
      background: linear-gradient(135deg, #1a1a1a 0%, #151515 100%);
      border: 1px solid var(--gb-border);
      border-radius: 20px;
      overflow: hidden;
      position: sticky;
      top: 200px;
      align-self: start;
    }

    .gb-profile-cover {
      height: 100px;
      background: linear-gradient(135deg, var(--gb-primary), var(--gb-primary-dark));
      position: relative;
    }

    .gb-profile-avatar {
      position: absolute;
      bottom: -50px;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, #222, #1a1a1a);
      border: 4px solid var(--gb-primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      font-weight: 800;
      color: var(--gb-primary);
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    }

    .gb-profile-info {
      padding: 90px 30px 30px; /* increased from 70px */
      text-align: center;
    }

    .gb-profile-name {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #fff 0%, var(--gb-primary) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .gb-profile-badge {
      display: inline-block;
      padding: 6px 20px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--gb-border);
      border-radius: 30px;
      font-size: 14px;
      font-weight: 600;
      color: var(--gb-text-muted);
      margin-bottom: 20px;
    }

    .gb-profile-badge.admin {
      background: rgba(255,68,68,0.1);
      border-color: #ff4444;
      color: #ff8888;
    }

    .gb-profile-badge.moderator {
      background: rgba(255,170,0,0.1);
      border-color: #ffaa00;
      color: #ffbb33;
    }

    .gb-profile-badge.verified {
      background: rgba(0,255,136,0.1);
      border-color: var(--gb-primary);
      color: var(--gb-primary);
    }

    .gb-profile-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin: 30px 0;
      padding: 30px 0;
      border-top: 1px solid var(--gb-border);
      border-bottom: 1px solid var(--gb-border);
    }

    .gb-stat {
      text-align: center;
    }

    .gb-stat-value {
      display: block;
      font-size: 28px;
      font-weight: 800;
      color: var(--gb-primary);
    }

    .gb-stat-label {
      font-size: 12px;
      color: var(--gb-text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .gb-trust-score {
      margin: 30px 0;
    }

    .gb-trust-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      color: var(--gb-text-muted);
      font-size: 14px;
    }

    .gb-trust-bar {
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
    }

    .gb-trust-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .gb-profile-bio {
      margin-top: 40px; /* increased from 30px */
      padding-top: 30px;
      border-top: 1px solid var(--gb-border);
    }

    .gb-profile-bio h3 {
      color: var(--gb-text);
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 15px;
    }

    .gb-profile-bio p {
      color: var(--gb-text-muted);
      line-height: 1.8;
    }

    .gb-profile-actions {
      margin-top: 30px;
      display: flex;
      gap: 15px;
    }

    .gb-btn {
      padding: 15px 30px;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      flex: 1;
    }

    .gb-btn-danger {
      background: rgba(255,68,68,0.1);
      border: 1px solid #ff4444;
      color: #ff8888;
    }

    .gb-btn-danger:hover {
      background: #ff4444;
      color: white;
    }

    .gb-btn-primary {
      background: linear-gradient(135deg, var(--gb-primary), var(--gb-primary-dark));
      color: black;
    }

    .gb-btn-outline {
      background: transparent;
      border: 2px solid var(--gb-border);
      color: var(--gb-text);
    }

    .gb-btn-outline:hover {
      border-color: var(--gb-primary);
      color: var(--gb-primary);
    }

    .gb-btn-block {
      width: 100%;
    }

    /* Profile Main Content */
    .gb-profile-main {
      background: linear-gradient(135deg, #1a1a1a 0%, #151515 100%);
      border: 1px solid var(--gb-border);
      border-radius: 20px;
      padding: 30px;
    }

    .gb-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 1px solid var(--gb-border);
      padding-bottom: 20px;
    }

    .gb-tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      color: var(--gb-text-muted);
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      border-radius: 10px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .gb-tab:hover {
      background: rgba(255,255,255,0.05);
      color: var(--gb-text);
    }

    .gb-tab.active {
      background: linear-gradient(135deg, rgba(0,255,136,0.15) 0%, rgba(0,255,136,0.05) 100%);
      color: var(--gb-primary);
    }

    .gb-tab-content {
      display: none;
    }

    .gb-tab-content.active {
      display: block;
    }

    /* Mod Cards */
    .gb-mod-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .gb-mod-card {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--gb-border);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.3s;
    }

    .gb-mod-card:hover {
      border-color: var(--gb-primary);
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,255,136,0.1);
    }

    .gb-mod-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--gb-text);
      margin-bottom: 10px;
    }

    .gb-mod-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 30px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 15px;
    }

    .gb-status-approved {
      background: rgba(0,255,136,0.1);
      border: 1px solid var(--gb-primary);
      color: var(--gb-primary);
    }

    .gb-status-pending {
      background: rgba(255,170,0,0.1);
      border: 1px solid #ffaa00;
      color: #ffaa00;
    }

    .gb-status-quarantined {
      background: rgba(255,68,68,0.1);
      border: 1px solid #ff4444;
      color: #ff8888;
    }

    .gb-mod-meta {
      display: flex;
      gap: 15px;
      margin: 15px 0;
      color: var(--gb-text-muted);
      font-size: 13px;
    }

    .gb-mod-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .gb-btn-small {
      padding: 10px 20px;
      font-size: 14px;
    }

    /* Stats Cards */
    .gb-stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-top: 20px;
    }

    .gb-stat-card {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--gb-border);
      border-radius: 16px;
      padding: 25px;
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .gb-stat-icon {
      font-size: 48px;
    }

    .gb-stat-info h4 {
      color: var(--gb-text-muted);
      font-size: 14px;
      margin-bottom: 5px;
    }

    .gb-stat-number {
      font-size: 36px;
      font-weight: 800;
      color: var(--gb-primary);
    }

    /* Settings Form */
    .gb-settings-form {
      max-width: 600px;
    }

    .gb-form-group {
      margin-bottom: 25px;
    }

    .gb-form-group label {
      display: block;
      margin-bottom: 10px;
      color: var(--gb-text-muted);
      font-weight: 600;
      font-size: 14px;
    }

    .gb-form-group input,
    .gb-form-group textarea {
      width: 100%;
      padding: 15px 20px;
      background: rgba(0,0,0,0.3);
      border: 2px solid var(--gb-border);
      border-radius: 12px;
      color: var(--gb-text);
      font-size: 16px;
      transition: all 0.2s;
    }

    .gb-form-group input:focus,
    .gb-form-group textarea:focus {
      outline: none;
      border-color: var(--gb-primary);
      background: rgba(0,255,136,0.05);
    }

    .gb-char-counter {
      display: block;
      text-align: right;
      font-size: 12px;
      color: var(--gb-text-muted);
      margin-top: 8px;
    }

    /* Loading State */
    .gb-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px;
      color: var(--gb-text-muted);
    }

    .gb-loading-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: var(--gb-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Error State */
    .gb-error {
      text-align: center;
      padding: 60px;
      background: linear-gradient(135deg, #1a1a1a 0%, #151515 100%);
      border: 1px solid #ff4444;
      border-radius: 20px;
      color: #ff8888;
    }

    .gb-error h2 {
      font-size: 32px;
      margin-bottom: 20px;
    }

    .gb-error p {
      margin-bottom: 30px;
      color: var(--gb-text-muted);
    }

    /* Ensure join date fits */
    .gb-stat-value.join-date {
      font-size: 18px;
      word-break: break-word;
      white-space: normal;
      line-height: 1.2;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .gb-profile-grid {
        grid-template-columns: 1fr;
      }
      .gb-profile-sidebar {
        position: static;
      }
    }

    @media (max-width: 768px) {
      .gb-profile-grid {
        grid-template-columns: 1fr;
      }
      .gb-profile-stats {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .gb-stat-value {
        font-size: 20px;
      }
      .gb-stat-label {
        font-size: 11px;
      }
      .gb-tabs {
        flex-wrap: wrap;
        justify-content: center;
      }
      .gb-tab {
        padding: 8px 16px;
        font-size: 14px;
      }
      .gb-profile-avatar {
        width: 80px;
        height: 80px;
        font-size: 36px;
        bottom: -40px;
      }
      .gb-profile-info {
        padding-top: 70px;
      }
    }

    @media (max-width: 480px) {
      .gb-profile-stats {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .gb-stat-value {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- GameBanana Header -->
  <header class="gb-header">
    <div class="gb-header-content">
      <div class="gb-logo">
        <span class="gb-logo-icon">üéì</span>
        <div class="gb-logo-text">
          <h1>BALDI MODS HUB</h1>
          <span class="gb-logo-tagline">GameBanana Style ‚Ä¢ Secure ‚Ä¢ Community</span>
        </div>
      </div>
    </div>
  </header>

  <!-- GameBanana Navigation -->
  <nav class="gb-nav" id="main-nav">
    <div class="gb-nav-container">
      <div class="gb-nav-links">
        <a href="index.html" class="gb-nav-item">üè† Home</a>
        <a href="upload.html" class="gb-nav-item">üì§ Upload</a>
        <a href="profile.html" class="gb-nav-item active">üë§ Profile</a>
        <a href="admin.html" class="gb-nav-item" id="nav-admin" style="display: none;">üõ°Ô∏è Moderation</a>
        <a href="admin-dashboard.html" class="gb-nav-item" id="nav-dashboard" style="display: none;">üìä Dashboard</a>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="gb-profile">
    <div id="profile-loading" class="gb-loading">
      <div class="gb-loading-spinner"></div>
      <p>Loading profile...</p>
    </div>
    
    <div id="profile-content" style="display: none;"></div>
  </main>

  <script src="script.js"></script>
  <script>
    // ============================================
    // Helper: getQueryParam
    // ============================================
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // ============================================
    // Wait for Supabase and handle both own/public profiles
    // ============================================
    (async function() {
      const waitForSupabase = async (maxAttempts = 30) => {
        for (let i = 0; i < maxAttempts; i++) {
          if (typeof window.supabaseClient !== 'undefined') return true;
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        return false;
      };
      await waitForSupabase();

      const targetUserId = getQueryParam("id");

      if (targetUserId) {
        // Public profile: load another user's profile
        document.getElementById('profile-loading').style.display = 'none';
        document.getElementById('profile-content').style.display = 'block';
        if (typeof window.loadPublicProfile === 'function') {
          window.loadPublicProfile(targetUserId);
        } else {
          console.error('loadPublicProfile function not found');
          document.getElementById('profile-content').innerHTML = '<div class="gb-error">Profile feature not available</div>';
        }
      } else {
        // Own profile: require login
        const { data: { user }, error } = await window.supabaseClient.auth.getUser();
        if (error || !user) {
          console.log('No user detected - redirecting to login');
          window.location.href = 'index.html?redirect=profile';
          return;
        }

        // User is logged in, hide loading and show profile
        document.getElementById('profile-loading').style.display = 'none';
        document.getElementById('profile-content').style.display = 'block';

        // Load profile data
        if (typeof window.loadProfilePage === 'function') {
          window.loadProfilePage();
        } else {
          console.error('loadProfilePage function not found');
          // Fallback profile render
          renderFallbackProfile(user);
        }

        // Load user's mods (if function exists)
        if (typeof window.loadMyMods === 'function') {
          window.loadMyMods();
        }

        // Update navigation (if function exists)
        if (typeof window.checkAuthState === 'function') {
          window.checkAuthState();
        }
      }
    })();

    // ============================================
    // FALLBACK: Render own profile if script.js functions missing
    // (kept from original)
    // ============================================
    async function renderFallbackProfile(user) {
      try {
        // Get or create profile
        let { data: profile } = await window.supabaseClient
          .from('profiles')
          .select('*')
          .eq('id', user.id)
          .single();

        if (!profile) {
          const { data: newProfile } = await window.supabaseClient
            .from('profiles')
            .insert({
              id: user.id,
              username: user.email.split('@')[0],
              email: user.email,
              role: 'user',
              trust_score: 100,
              is_verified: false,
              join_date: new Date().toISOString(),
              upload_count: 0,
              download_count: 0
            })
            .select()
            .single();
          profile = newProfile;
        }

        renderGameBananaProfile(profile, user);
      } catch (err) {
        console.error('Failed to load profile:', err);
        document.getElementById('profile-content').innerHTML = `
          <div class="gb-card" style="text-align: center; padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
            <h2 style="color: var(--gb-danger); margin-bottom: 10px;">Failed to Load Profile</h2>
            <p style="color: var(--gb-text-muted); margin-bottom: 20px;">Please try refreshing the page.</p>
            <a href="index.html" class="gb-btn gb-btn-primary" style="text-decoration: none;">‚Üê Back to Home</a>
          </div>
        `;
      }
    }

    // ============================================
    // GAMEBANANA PROFILE RENDER (fallback)
    // ============================================
    function renderGameBananaProfile(profile, user) {
      const container = document.getElementById('profile-content');
      const username = profile?.username || user.email?.split('@')[0] || 'User';
      const joinDate = profile?.join_date ? new Date(profile.join_date).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      }) : 'Today';
      const trustScore = profile?.trust_score || 100;

      let trustColor = '#ff4444';
      if (trustScore >= 80) trustColor = '#00ff88';
      else if (trustScore >= 50) trustColor = '#ffaa00';

      let roleBadge = '';
      if (profile?.role === 'admin') {
        roleBadge = '<span class="gb-profile-badge admin">üëë ADMINISTRATOR</span>';
      } else if (profile?.role === 'moderator') {
        roleBadge = '<span class="gb-profile-badge moderator">üõ°Ô∏è MODERATOR</span>';
      } else if (profile?.is_verified) {
        roleBadge = '<span class="gb-profile-badge verified">‚úÖ VERIFIED</span>';
      } else {
        roleBadge = '<span class="gb-profile-badge">üë§ MEMBER</span>';
      }

      container.innerHTML = `
        <div class="gb-profile-grid">
          <!-- Sidebar -->
          <div class="gb-profile-sidebar">
            <div class="gb-profile-cover"></div>
            <div class="gb-profile-avatar">
              ${username.charAt(0).toUpperCase()}
            </div>
            <div class="gb-profile-info">
              <h2 class="gb-profile-name">${escapeHTML(username)}</h2>
              ${roleBadge}

              <div class="gb-profile-stats">
                <div class="gb-stat">
                  <span class="gb-stat-value">${profile?.upload_count || 0}</span>
                  <span class="gb-stat-label">Uploads</span>
                </div>
                <div class="gb-stat">
                  <span class="gb-stat-value">${profile?.download_count || 0}</span>
                  <span class="gb-stat-label">Downloads</span>
                </div>
                <div class="gb-stat">
                  <span class="gb-stat-value join-date">${joinDate}</span>
                  <span class="gb-stat-label">Joined</span>
                </div>
              </div>

              <div class="gb-trust-score">
                <div class="gb-trust-header">
                  <span>Trust Score</span>
                  <span style="color: ${trustColor};">${trustScore}%</span>
                </div>
                <div class="gb-trust-bar">
                  <div class="gb-trust-fill" style="width: ${trustScore}%; background: ${trustColor};"></div>
                </div>
              </div>

              <div class="gb-profile-bio">
                <h3>About</h3>
                <p>${escapeHTML(profile?.bio || 'No bio yet. Click settings to add one!')}</p>
              </div>

              <div class="gb-profile-actions">
                <button onclick="logout()" class="gb-btn gb-btn-danger">
                  üö™ Sign Out
                </button>
              </div>
            </div>
          </div>

          <!-- Main Content -->
          <div class="gb-profile-main">
            <div class="gb-tabs">
              <button class="gb-tab active" onclick="window.switchTab('uploads')">üì¶ My Mods</button>
              <button class="gb-tab" onclick="window.switchTab('stats')">üìä Statistics</button>
              <button class="gb-tab" onclick="window.switchTab('settings')">‚öôÔ∏è Settings</button>
            </div>

            <!-- Uploads Tab -->
            <div id="uploads-tab" class="gb-tab-content active">
              <h3 style="color: var(--gb-primary); margin-bottom: 20px;">My Uploaded Mods</h3>
              <div id="myMods" class="gb-mod-grid">
                <div class="gb-loading" style="padding: 40px;">
                  <div class="gb-loading-spinner" style="width: 30px; height: 30px;"></div>
                  <p>Loading your mods...</p>
                </div>
              </div>
            </div>

            <!-- Stats Tab -->
            <div id="stats-tab" class="gb-tab-content">
              <h3 style="color: var(--gb-primary); margin-bottom: 20px;">Your Statistics</h3>
              <div class="gb-stats-grid">
                <div class="gb-stat-card">
                  <div class="gb-stat-icon">üì§</div>
                  <div class="gb-stat-info">
                    <h4>Total Uploads</h4>
                    <span class="gb-stat-number" id="statTotalUploads">0</span>
                  </div>
                </div>
                <div class="gb-stat-card">
                  <div class="gb-stat-icon">‚úÖ</div>
                  <div class="gb-stat-info">
                    <h4>Approved</h4>
                    <span class="gb-stat-number" id="statApprovedMods">0</span>
                  </div>
                </div>
                <div class="gb-stat-card">
                  <div class="gb-stat-icon">‚è≥</div>
                  <div class="gb-stat-info">
                    <h4>Pending</h4>
                    <span class="gb-stat-number" id="statPendingMods">0</span>
                  </div>
                </div>
                <div class="gb-stat-card">
                  <div class="gb-stat-icon">üì•</div>
                  <div class="gb-stat-info">
                    <h4>Downloads</h4>
                    <span class="gb-stat-number" id="statTotalDownloads">0</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="gb-tab-content">
              <h3 style="color: var(--gb-primary); margin-bottom: 20px;">Profile Settings</h3>
              <form class="gb-settings-form" onsubmit="event.preventDefault(); updateProfile();">
                <div class="gb-form-group">
                  <label for="displayName">Display Name</label>
                  <input type="text" id="displayName" value="${escapeHTML(username)}" maxlength="30" placeholder="Enter your display name">
                  <span class="gb-char-counter" id="nameCounter">${username.length}/30</span>
                </div>
                <div class="gb-form-group">
                  <label for="userBio">Bio</label>
                  <textarea id="userBio" rows="4" maxlength="500" placeholder="Tell the community about yourself...">${escapeHTML(profile?.bio || '')}</textarea>
                  <span class="gb-char-counter" id="bioCounter">${profile?.bio?.length || 0}/500</span>
                </div>
                <div class="gb-form-group">
                  <label for="email">Email Address</label>
                  <input type="email" id="email" value="${escapeHTML(user.email)}" disabled style="background: rgba(0,0,0,0.5); opacity: 0.7;">
                  <span class="gb-char-counter">Cannot be changed</span>
                </div>
                <button type="submit" class="gb-btn gb-btn-primary" style="width: 100%;">üíæ Save Changes</button>
              </form>
            </div>
          </div>
        </div>
      `;

      // Load stats
      loadUserStatsFallback();
    }

    // ============================================
    // FALLBACK FUNCTIONS
    // ============================================
    async function loadUserStatsFallback() {
      const user = await getCurrentUserFallback();
      if (!user) return;

      try {
        const { data: mods } = await window.supabaseClient
          .from('mods2')
          .select('*')
          .eq('user_id', user.id);

        const totalUploads = mods?.length || 0;
        const approvedMods = mods?.filter(m => m.approved).length || 0;
        const pendingMods = mods?.filter(m => !m.approved && !m.quarantine).length || 0;
        const totalDownloads = mods?.reduce((sum, m) => sum + (m.download_count || 0), 0) || 0;

        document.getElementById('statTotalUploads').textContent = totalUploads;
        document.getElementById('statApprovedMods').textContent = approvedMods;
        document.getElementById('statPendingMods').textContent = pendingMods;
        document.getElementById('statTotalDownloads').textContent = totalDownloads;
      } catch (err) {
        console.error('Failed to load stats:', err);
      }
    }

    async function getCurrentUserFallback() {
      try {
        const { data: { user } } = await window.supabaseClient.auth.getUser();
        return user;
      } catch {
        return null;
      }
    }

    // ============================================
    // UTILITIES
    // ============================================
    function escapeHTML(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // ============================================
    // TAB SWITCHING
    // ============================================
    window.switchTab = function(tabName) {
      document.querySelectorAll('.gb-tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.gb-tab').forEach(btn => btn.classList.remove('active'));

      const tabEl = document.getElementById(`${tabName}-tab`);
      if (tabEl) tabEl.classList.add('active');
      if (event.target) event.target.classList.add('active');

      if (tabName === 'stats') {
        if (typeof loadUserStats === 'function') {
          loadUserStats();
        } else {
          loadUserStatsFallback();
        }
      }
    };

    // ============================================
    // CHARACTER COUNTERS
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        const displayName = document.getElementById('displayName');
        const userBio = document.getElementById('userBio');

        if (displayName) {
          displayName.addEventListener('input', function() {
            const counter = document.getElementById('nameCounter');
            if (counter) counter.textContent = `${this.value.length}/30`;
          });
        }

        if (userBio) {
          userBio.addEventListener('input', function() {
            const counter = document.getElementById('bioCounter');
            if (counter) counter.textContent = `${this.value.length}/500`;
          });
        }
      }, 500);
    });
  </script>
</body>
</html>